
CREATE TABLE users
(
    id            UUID PRIMARY KEY                  DEFAULT gen_random_uuid(),
    email         VARCHAR(255) UNIQUE      NOT NULL,
    password_hash TEXT                     NOT NULL,
    username      VARCHAR(100) UNIQUE,
    created_at    TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at    TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Create wallets table
CREATE TABLE wallets
(
    id         UUID PRIMARY KEY     DEFAULT gen_random_uuid(),
    user_id    UUID        NOT NULL REFERENCES users (id) ON DELETE CASCADE,
    currency   CHAR(3)     NOT NULL CHECK (currency IN
                                           ('USD', 'NGN', 'GBP', 'EUR', 'CAD', 'AUD', 'JPY', 'CHF', 'CNY',
                                            'SEK', 'NZD', 'MXN', 'SGD', 'HKD', 'NOK', 'KRW', 'TRY', 'INR',
                                            'BRL', 'ZAR')),
    balance    BIGINT      NOT NULL DEFAULT 0 CHECK (balance >= 0),
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    CONSTRAINT wallets_user_currency_key UNIQUE (user_id, currency)
);

-- Create transactions table
CREATE TABLE transactions
(
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Who initiated this
    user_id UUID NOT NULL
        REFERENCES users (id) ON DELETE CASCADE,

    -- Receiver (for transfers / payouts)
    counterparty_id UUID
        REFERENCES users (id),

    -- What the user is trying to do
    intent VARCHAR(30) NOT NULL CHECK (
        intent IN ('topup', 'payout', 'transfer', 'conversion')
        ),

    -- Nominal amount (NOT ledger)
    amount BIGINT NOT NULL CHECK (amount > 0),
    currency CHAR(3) NOT NULL,

    -- Payment lifecycle (only meaningful for external providers)
    payment_state VARCHAR(30) NOT NULL CHECK (
        payment_state IN (
                          'pending',
                          'requires_action',
                          'completed',
                          'failed',
                          'cancelled'
            )
        ),

    -- External processor (NULL for internal flows)
    provider VARCHAR(20) CHECK (
        provider IN ('stripe', 'paypal', 'paystack', 'internal')
        ),

    -- Stripe session, PayPal order, Paystack ref
    provider_reference TEXT UNIQUE,

    -- Safety & correlation
    idempotency_key TEXT NOT NULL,
    reference UUID NOT NULL UNIQUE,

    description TEXT,
    metadata JSONB CHECK (jsonb_typeof(metadata) = 'object'),

    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- One logical action per user per key
    UNIQUE (user_id, idempotency_key)
);

CREATE TABLE wallet_ledger
(
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    wallet_id UUID NOT NULL
        REFERENCES wallets (id) ON DELETE CASCADE,

    transaction_id UUID NOT NULL
        REFERENCES transactions (id) ON DELETE CASCADE,

    -- SIGNED amount:
    amount BIGINT NOT NULL,

    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- One ledger entry per wallet per transaction
    UNIQUE (wallet_id, transaction_id)
);



-- Create bank_accounts table
CREATE TABLE bank_accounts
(
    id                    UUID PRIMARY KEY     DEFAULT gen_random_uuid(),
    user_id               UUID        NOT NULL REFERENCES users (id) ON DELETE CASCADE,
    bank_code             VARCHAR(10) NOT NULL,
    account_number        VARCHAR(20) NOT NULL,
    account_name          VARCHAR(255),
    bank_name             VARCHAR(255),

    provider_recipient_id TEXT, -- paystack / etc

    is_verified           BOOLEAN     NOT NULL DEFAULT FALSE,
    created_at            TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at            TIMESTAMPTZ NOT NULL DEFAULT now(),

    UNIQUE (bank_code, account_number)
);


CREATE TABLE banks
(
    id        BIGINT PRIMARY KEY,
    name      TEXT    NOT NULL,
    code      TEXT    NOT NULL UNIQUE,
    currency  CHAR(3) NOT NULL,
    country   CHAR(2) NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT true
);



CREATE TABLE blacklisted_tokens
(
    jti        TEXT PRIMARY KEY,
    expires_at TIMESTAMPTZ NOT NULL
);

CREATE TABLE refresh_tokens
(
    id         UUID PRIMARY KEY                  DEFAULT gen_random_uuid(),
    user_id    UUID                     NOT NULL REFERENCES users (id) ON DELETE CASCADE,
    token_hash TEXT                     NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    revoked    BOOLEAN                  NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

SELECT diesel_manage_updated_at('refresh_tokens');


-- Create indexes
CREATE INDEX idx_transactions_user_id ON transactions (user_id);
CREATE INDEX idx_transactions_reference ON transactions (reference);
CREATE INDEX idx_bank_accounts_user_id ON bank_accounts (user_id);
CREATE INDEX idx_blacklisted_tokens_expires_at ON blacklisted_tokens (expires_at);
CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens (user_id);
CREATE INDEX idx_refresh_tokens_hash ON refresh_tokens (token_hash);
CREATE INDEX idx_refresh_tokens_expires ON refresh_tokens (expires_at);
CREATE INDEX idx_refresh_tokens_revoked ON refresh_tokens (revoked);

CREATE INDEX idx_transactions_user ON transactions (user_id);
CREATE INDEX idx_transactions_provider_ref ON transactions (provider_reference);
CREATE INDEX idx_transactions_state ON transactions (payment_state);
CREATE INDEX idx_wallets_user ON wallets (user_id);
CREATE INDEX idx_ledger_wallet ON wallet_ledger (wallet_id);



-- Create function to update updated_at column
CREATE OR REPLACE FUNCTION update_updated_at_column()
    RETURNS TRIGGER AS
$$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create triggers for updated_at
CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE
    ON users
    FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_wallets_updated_at
    BEFORE UPDATE
    ON wallets
    FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_transactions_updated_at
    BEFORE UPDATE
    ON transactions
    FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_bank_accounts_updated_at
    BEFORE UPDATE
    ON bank_accounts
    FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();




//=====

-- This file should undo anything in `up.sql`
-- Drop indexes
DROP INDEX IF EXISTS idx_bank_accounts_user_id;
DROP INDEX IF EXISTS idx_transactions_reference;
DROP INDEX IF EXISTS idx_transactions_recipient_id;
DROP INDEX IF EXISTS idx_transactions_user_id;

-- Drop tables in reverse order to respect foreign key constraints
DROP TABLE IF EXISTS bank_accounts;
DROP TABLE IF EXISTS transactions;
DROP TABLE IF EXISTS wallets;
DROP TABLE IF EXISTS users;
DROP TABLE IF EXISTS banks;
DROP TABLE refresh_tokens;
